# RegionAverage
Script to average integrated intensity and calculate statistics of individual regions in moment-0 maps. Regions can be generated by code (hexagonal or circular regions with user's choice of size) or uploaded by user as ds9 .reg file

## BEFORE RUNNING CODE
Before running `region_average`, you will need to create a CSV file with one row per molecular transition and with the following columns:

- `species` [string]: Name of molecular species
- `transition` [string]: Name of molecular transition
- `chanrms` [float]: Single-channel rms in Jy
- `intimage` [string]: Path to integrated intensity images
- `fwzi` [float] : Full width at zero intensity in km/s
- `chanwidth` [float]: Spectral channel width in km/s
- `fluxcaluncert` [float]: Flux calibration uncertainty (fraction from 0 to 1)

An example input CSV file row:

`HC15N	1-0	0.18	/Users/eb7he/HCNHNC/NGC253_HC15N_10_moment0.fits	100	10.0	0.15`

## USER INPUT
### Input CSV file
When running `region_average`, you will be prompted to enter the path to the input csv file--if the csv file is in your working directory, you can simply enter the file name; otherwise, enter the full path to the csv file.

### Region Definition
You have the option to let the code generate regions or to supply a ds9 .reg file with your own regions. 

If you choose to allow the code to generate regions, you have the option of either hexagons or circles. Hexagons will cover the full image without spaces between regions, while circular regions will leave some wasted space. Follow the code's prompts, specifying region size in units of either pc or arcsec (code will ask you to confirm units before specifying region size). If you're using images that have been masked and thus contain NaN values for some pixels, you also have the option of specifying the maximum fraction of a region that can be filled with NaN values before it's discarded. When prompted, enter a number between 0 and 1 (0 indicating that regions with any NaN pixels at all will be discarded, 1 indicating that regions with 100% NaN pixels will be retained). If you have no NaN values in your integrated intensity images, your input for this prompt will not affect the code's output.

If you choose to supply your own .reg file, be sure that it is in the ds9 format and contains the following in the first line of the file:

`# Region file format: DS9 astropy/regions`

At this time, only circular or hexagonal regions are supported.

## Code Output

If you input your own ds9 .reg file, the only output will be the output CSV file `region_avg_stats.csv`. The output CSV table will have the following column names:
`species`, `transition`, `intimage`, `chanrms`, `chanwidth`, `fluxcaluncert`, `regionra`, `regiondec`, `averint`, `rmsaver`, `rmsint`, `rmsint_measnoiseportion`, `rmsint_fluxcalportion`

with one row per region.

The first 6 columns are the same as the input csv file. Additionally,

- `regionra` and `regiondec` = RA and Dec of center pixel in that region
- `averint` = averaged integrated intensity over region
- `rmsaver` = spatial rms over region 
- `rmsint` = rms of integrated intensity
- `rmsint_measnoiseportion` = measured noise portion of the rms, used to calculate `rmsint`
- `rmsint_fluxcalportion` = flux calibration portion of the rms, used to calculate `rmsint`

If you chose to have the the code define regions, you will get the same output CSV file but named 
`reg_avg_{Shape}{Shapesize}_{Nanpct}.csv`, with the user-defined region, size, and NaN percentage in the file name (e.g. `reg_avg_hex50pc_0.8.csv`). The code will also output 2 ds9 .reg files per transition: one with full region coverage over the whole image (before Nan-filled regions are discarded) and one with region coverage only over the key areas in the image (after NaN-filled/background regions are discarded), named respectively 
`{Species}{Transition}_{Shape}{Size}_full.reg` and `{Species}{Transition}_{Shape}{Size}_{Nanpct}_final.reg` (e.g. `HNC3-2_hex26pc_full.reg` and `HNC3-2_hex26pc_0.5_final.reg`).
